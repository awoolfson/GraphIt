<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphing Calculator</title>
</head>
<body>
    <h1>Graphing Calculator</h1>
    
    <form id="calculator-form">
        <label for="xsize">X Size:</label>
        <input type="number" id="xsize" value=32><br><br>

        <label for="ysize">Y Size:</label>
        <input type="number" id="ysize" value=32><br><br>

        <label for="color">Color:</label>
        <input type="text" id="color" value="cyan"><br><br>

        <label for="expression">Expression:</label>
        <input type="text" id="expression" value="2x"><br><br>

        <button type="button" id="generate-button">Generate Graph</button>
    </form>

    <canvas id="graph" width=540 height=540></canvas>

    <script type="module">
        import init, {wasm_gen_image} from './pkg/rust_graphing_calc.js';

        await init(); // Initialize the Wasm module
        console.log('Wasm module initialized');

        const canvas = document.getElementById('graph');
        const ctx = canvas.getContext('2d');
          
        const generateButton = document.getElementById('generate-button');
        generateButton.addEventListener('click', () => {
            const color = document.getElementById('color').value;
            const xsize = document.getElementById('xsize').value;
            const ysize = document.getElementById('ysize').value;
            const expression = document.getElementById('expression').value;

            const image = new Uint8ClampedArray(wasm_gen_image(color, xsize, ysize, expression));
            const settings = {
                colorSpace: "srgb", // Can be set to "srgb" or "display-p3"
            };
            const imageData = new ImageData(image, canvas.width, canvas.height, settings);

            console.log(imageData.colorSpace);
            console.log(imageData.width);
            console.log(imageData.height);
            console.log(imageData.data);

            const bitmapPromise = createImageBitmap(imageData);
            bitmapPromise.then((bitmap) => {
                console.log(bitmap);
                ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
            }).catch((error) => {
                console.log(error);
            });
            console.log('end');
        });
    </script>
</body>
</html>